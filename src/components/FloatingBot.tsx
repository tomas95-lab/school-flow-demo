import React, { useState, useContext, useRef, useEffect } from 'react';
import { AuthContext } from '@/context/AuthContext';
import { useFirestoreCollection } from '@/hooks/useFireStoreCollection';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { ScrollArea } from '@/components/ui/scroll-area';
import { Badge } from '@/components/ui/badge';
import { Card, CardContent } from '@/components/ui/card';
import { 
  Bot, 
  X, 
  Send,
  TrendingUp,
  AlertTriangle,
  Users,
  BarChart3,
  Zap,
  Minimize2,
  Maximize2,
  Trash2,
  MessageCircle,
  ChevronDown,
  ChevronUp,
} from 'lucide-react';

interface BotMessage {
  id: string;
  type: 'user' | 'bot';
  content: string;
  timestamp: Date;
  suggestions?: string[];
}

interface QuickAction {
  id: string;
  title: string;
  description: string;
  icon: React.ComponentType<any>;
  action: () => void;
  color: string;
}

const FloatingBot: React.FC = () => {
  const { user } = useContext(AuthContext);
  const [isOpen, setIsOpen] = useState(false);
  const [isMinimized, setIsMinimized] = useState(false);
  const [messages, setMessages] = useState<BotMessage[]>([]);
  const [inputValue, setInputValue] = useState('');
  const [isTyping, setIsTyping] = useState(false);
  const [showQuickActions, setShowQuickActions] = useState(false);
  const [messageCount, setMessageCount] = useState(0);
  const messagesEndRef = useRef<HTMLDivElement>(null);
  const inputRef = useRef<HTMLInputElement>(null);

  // Fetch data for intelligent responses
  const { data: students } = useFirestoreCollection('students');
  const { data: courses } = useFirestoreCollection('courses');
  const { data: teachers } = useFirestoreCollection('users');
  const { data: subjects } = useFirestoreCollection('subjects');
  const { data: attendances } = useFirestoreCollection('attendances');
  const { data: calificaciones } = useFirestoreCollection('calificaciones');
  const { data: boletines } = useFirestoreCollection('boletines');
  const { data: alerts } = useFirestoreCollection('alerts');

  // Auto-scroll to bottom
  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [messages]);

  // Focus input when opened
  useEffect(() => {
    if (isOpen && !isMinimized) {
      setTimeout(() => {
        inputRef.current?.focus();
      }, 100);
    }
  }, [isOpen, isMinimized]);

  // Initialize bot with welcome message
  useEffect(() => {
    if (messages.length === 0 && user?.email && isOpen) {
      addBotMessage(
        `¬°Hola ${user.email.split('@')[0]}! Soy tu asistente IA. ü§ñ

¬øEn qu√© puedo ayudarte hoy?`,
        [
          'üìä Analizar rendimiento acad√©mico',
          'üìà Ver estad√≠sticas de asistencia',
          '‚ö†Ô∏è Identificar estudiantes en riesgo',
          'üìã Consultar datos del sistema'
        ]
      );
    }
  }, [user?.email, isOpen, messages.length]);

  const addBotMessage = (content: string, suggestions?: string[]) => {
    const message: BotMessage = {
      id: Date.now().toString(),
      type: 'bot',
      content,
      timestamp: new Date(),
      suggestions
    };
    setMessages(prev => [...prev, message]);
    setMessageCount(prev => prev + 1);
  };

  const addUserMessage = (content: string) => {
    const message: BotMessage = {
      id: Date.now().toString(),
      type: 'user',
      content,
      timestamp: new Date()
    };
    setMessages(prev => [...prev, message]);
    setMessageCount(prev => prev + 1);
  };

  // Quick Actions
  const quickActions: QuickAction[] = [
    {
      id: 'performance',
      title: 'Rendimiento',
      description: 'Analizar calificaciones',
      icon: TrendingUp,
      action: () => handleQuickAction('Analizar rendimiento acad√©mico'),
      color: 'bg-green-500'
    },
    {
      id: 'attendance',
      title: 'Asistencia',
      description: 'Ver estad√≠sticas',
      icon: Users,
      action: () => handleQuickAction('Ver estad√≠sticas de asistencia'),
      color: 'bg-blue-500'
    },
    {
      id: 'risk',
      title: 'Riesgo',
      description: 'Identificar problemas',
      icon: AlertTriangle,
      action: () => handleQuickAction('Identificar estudiantes en riesgo'),
      color: 'bg-red-500'
    },
    {
      id: 'stats',
      title: 'Estad√≠sticas',
      description: 'Datos del sistema',
      icon: BarChart3,
      action: () => handleQuickAction('Mostrar estad√≠sticas del sistema'),
      color: 'bg-purple-500'
    }
  ];

  const handleQuickAction = async (action: string) => {
    if (!isOpen) return;
    
    addUserMessage(action);
    setShowQuickActions(false);
    setIsTyping(true);
    const response = await generateBotResponse(action);
    addBotMessage(response);
    setIsTyping(false);
  };

  // Intelligent response generation with advanced logic
  const generateBotResponse = async (userInput: string): Promise<string> => {
    const input = userInput.toLowerCase();
    setIsTyping(true);

    // Simulate typing delay
    await new Promise(resolve => setTimeout(resolve, 500 + Math.random() * 800));

    // Advanced context detection with multiple keywords
    const context = analyzeContext(input);
    
    // Generate response based on context
    switch (context.type) {
      case 'academic_performance':
        return generateAdvancedAcademicAnalysis(context.details);
      case 'attendance':
        return generateAdvancedAttendanceAnalysis(context.details);
      case 'risk_assessment':
        return generateAdvancedRiskAnalysis(context.details);
      case 'system_stats':
        return generateAdvancedSystemStats(context.details);
      case 'user_management':
        return generateAdvancedUserInfo(context.details);
      case 'student_info':
        return generateAdvancedStudentInfo(context.details);
      case 'teacher_info':
        return generateAdvancedTeacherInfo(context.details);
      case 'course_info':
        return generateAdvancedCourseInfo(context.details);
      case 'subject_info':
        return generateAdvancedSubjectInfo(context.details);
      case 'boletin_info':
        return generateAdvancedBoletinInfo(context.details);
      case 'alert_info':
        return generateAdvancedAlertInfo(context.details);
      case 'comparison':
        return generateComparisonAnalysis(context.details);
      case 'prediction':
        return generatePredictionAnalysis(context.details);
      case 'recommendation':
        return generateRecommendationAnalysis(context.details);
      case 'help':
        return generateAdvancedHelpResponse(context.details);
      case 'greeting':
        return generateAdvancedGreeting(context.details);
      default:
        return generateIntelligentGeneralResponse(input, context);
    }
  };

  // Advanced context analysis
  const analyzeContext = (input: string) => {
    const context: any = {
      type: 'general',
      details: {},
      keywords: [] as string[],
      intent: 'query',
      urgency: 'normal',
      complexity: 'basic'
    };

    // Extract keywords and determine intent
    const keywords = input.split(' ').filter(word => word.length > 2);
    context.keywords = keywords as string[];

    // Detect urgency
    if (input.includes('urgente') || input.includes('cr√≠tico') || input.includes('inmediato')) {
      context.urgency = 'high';
    }

    // Detect complexity
    if (input.includes('detallado') || input.includes('completo') || input.includes('an√°lisis profundo')) {
      context.complexity = 'advanced';
    }

    // Advanced pattern matching
    if (input.includes('rendimiento') || input.includes('notas') || input.includes('calificaciones') || 
        input.includes('promedio') || input.includes('excelente') || input.includes('bajo')) {
      context.type = 'academic_performance';
      context.details = {
        focus: input.includes('promedio') ? 'average' : 
               input.includes('excelente') ? 'high_performers' :
               input.includes('bajo') ? 'low_performers' : 'general',
        period: input.includes('trimestre') ? 'quarter' : 
                input.includes('semestre') ? 'semester' : 'all',
        comparison: input.includes('comparar') || input.includes('vs') || input.includes('entre')
      };
    } else if (input.includes('asistencia') || input.includes('ausencia') || input.includes('presente') || 
               input.includes('falta') || input.includes('tardanza')) {
      context.type = 'attendance';
      context.details = {
        focus: input.includes('tardanza') ? 'late' : 
               input.includes('falta') ? 'absent' : 'general',
        period: input.includes('semana') ? 'week' : 
                input.includes('mes') ? 'month' : 'all',
        trend: input.includes('tendencia') || input.includes('evoluci√≥n')
      };
    } else if (input.includes('riesgo') || input.includes('problema') || input.includes('alerta') || 
               input.includes('cr√≠tico') || input.includes('urgente')) {
      context.type = 'risk_assessment';
      context.details = {
        level: input.includes('cr√≠tico') ? 'critical' : 
               input.includes('alto') ? 'high' : 'general',
        type: input.includes('acad√©mico') ? 'academic' : 
              input.includes('asistencia') ? 'attendance' : 'combined'
      };
    } else if (input.includes('usuario') || input.includes('usuarios') || input.includes('crear') || 
               input.includes('agregar') || input.includes('nuevo')) {
      context.type = 'user_management';
      context.details = {
        action: input.includes('crear') || input.includes('agregar') ? 'create' : 'info',
        role: input.includes('admin') ? 'admin' : 
              input.includes('profesor') ? 'teacher' : 'general'
      };
    } else if (input.includes('estudiante') || input.includes('estudiantes') || input.includes('alumno')) {
      context.type = 'student_info';
      context.details = {
        focus: input.includes('mejor') ? 'top' : 
               input.includes('peor') ? 'bottom' : 'general',
        course: extractCourseFromInput(input),
        grade: extractGradeFromInput(input)
      };
    } else if (input.includes('profesor') || input.includes('profesores') || input.includes('docente')) {
      context.type = 'teacher_info';
      context.details = {
        focus: input.includes('mejor') ? 'top' : 'general',
        subject: extractSubjectFromInput(input)
      };
    } else if (input.includes('curso') || input.includes('cursos') || input.includes('grado')) {
      context.type = 'course_info';
      context.details = {
        course: extractCourseFromInput(input),
        comparison: input.includes('comparar') || input.includes('vs')
      };
    } else if (input.includes('materia') || input.includes('materias') || input.includes('asignatura')) {
      context.type = 'subject_info';
      context.details = {
        subject: extractSubjectFromInput(input),
        performance: input.includes('rendimiento') || input.includes('promedio')
      };
    } else if (input.includes('bolet√≠n') || input.includes('boletines') || input.includes('reporte')) {
      context.type = 'boletin_info';
      context.details = {
        action: input.includes('generar') ? 'generate' : 'info',
        period: extractPeriodFromInput(input)
      };
    } else if (input.includes('alerta') || input.includes('alertas') || input.includes('notificaci√≥n')) {
      context.type = 'alert_info';
      context.details = {
        type: input.includes('cr√≠tica') ? 'critical' : 'general',
        status: input.includes('activa') ? 'active' : 'all'
      };
    } else if (input.includes('comparar') || input.includes('vs') || input.includes('entre') || 
               input.includes('diferencias')) {
      context.type = 'comparison';
      context.details = {
        entities: extractComparisonEntities(input),
        metric: extractMetricFromInput(input)
      };
    } else if (input.includes('predicci√≥n') || input.includes('futuro') || input.includes('tendencia') || 
               input.includes('proyecci√≥n')) {
      context.type = 'prediction';
      context.details = {
        timeframe: extractTimeframeFromInput(input),
        metric: extractMetricFromInput(input)
      };
    } else if (input.includes('recomendaci√≥n') || input.includes('sugerencia') || input.includes('mejorar') || 
               input.includes('optimizar')) {
      context.type = 'recommendation';
      context.details = {
        area: extractAreaFromInput(input),
        priority: input.includes('urgente') ? 'high' : 'normal'
      };
    } else if (input.includes('ayuda') || input.includes('comandos') || input.includes('funciones')) {
      context.type = 'help';
      context.details = {
        category: extractHelpCategory(input)
      };
    } else if (input.includes('hola') || input.includes('buenos d√≠as') || input.includes('buenas')) {
      context.type = 'greeting';
      context.details = {
        time: new Date().getHours(),
        user: user?.email?.split('@')[0]
      };
    }

    return context;
  };

  // Helper functions for context analysis
  const extractCourseFromInput = (input: string): string | null => {
    const coursePatterns = ['primero', 'segundo', 'tercero', 'cuarto', 'quinto', 'sexto', 's√©ptimo', 'octavo', 'noveno', 'd√©cimo'];
    for (const pattern of coursePatterns) {
      if (input.includes(pattern)) return pattern;
    }
    return null;
  };

  const extractSubjectFromInput = (input: string): string | null => {
    const subjectPatterns = ['matem√°ticas', 'matematica', 'espa√±ol', 'ciencias', 'historia', 'geograf√≠a', 'ingl√©s', 'ingles', 'arte', 'f√≠sica', 'fisica', 'qu√≠mica', 'quimica'];
    for (const pattern of subjectPatterns) {
      if (input.includes(pattern)) return pattern;
    }
    return null;
  };

  const extractGradeFromInput = (input: string): number | null => {
    const gradeMatch = input.match(/(\d+(?:\.\d+)?)/);
    return gradeMatch ? parseFloat(gradeMatch[1]) : null;
  };

  const extractPeriodFromInput = (input: string): string => {
    if (input.includes('trimestre')) return 'quarter';
    if (input.includes('semestre')) return 'semester';
    if (input.includes('mes')) return 'month';
    return 'all';
  };

  const extractComparisonEntities = (input: string): string[] => {
    const entities: string[] = [];
    if (input.includes('curso')) entities.push('courses');
    if (input.includes('materia')) entities.push('subjects');
    if (input.includes('estudiante')) entities.push('students');
    if (input.includes('profesor')) entities.push('teachers');
    return entities;
  };

  const extractMetricFromInput = (input: string): string => {
    if (input.includes('promedio')) return 'average';
    if (input.includes('asistencia')) return 'attendance';
    if (input.includes('rendimiento')) return 'performance';
    return 'general';
  };

  const extractTimeframeFromInput = (input: string): string => {
    if (input.includes('semana')) return 'week';
    if (input.includes('mes')) return 'month';
    if (input.includes('trimestre')) return 'quarter';
    return 'semester';
  };

  const extractAreaFromInput = (input: string): string => {
    if (input.includes('acad√©mico')) return 'academic';
    if (input.includes('asistencia')) return 'attendance';
    if (input.includes('sistema')) return 'system';
    return 'general';
  };

  const extractHelpCategory = (input: string): string => {
    if (input.includes('an√°lisis')) return 'analysis';
    if (input.includes('usuario')) return 'users';
    if (input.includes('reporte')) return 'reports';
    return 'general';
  };

  const generateAdvancedAcademicAnalysis = (details: any): string => {
    if (!students || !calificaciones) {
      return '‚ùå No tengo suficientes datos de estudiantes y calificaciones para realizar el an√°lisis.';
    }

    const totalStudents = students.length;
    const totalGrades = calificaciones.length;
    const averageGrade = calificaciones.reduce((sum, g) => sum + g.valor, 0) / totalGrades;
    
    // Advanced analysis based on context
    let analysis = `üìä **An√°lisis Avanzado de Rendimiento Acad√©mico**\n\n`;
    
    if (details.focus === 'average') {
      analysis += `üéØ **An√°lisis de Promedios:**\n`;
      analysis += `‚Ä¢ Promedio general: **${averageGrade.toFixed(2)}**\n`;
      
      // Calculate median
      const sortedGrades = calificaciones.map(g => g.valor).sort((a, b) => a - b);
      const median = sortedGrades[Math.floor(sortedGrades.length / 2)];
      analysis += `‚Ä¢ Mediana: **${median.toFixed(2)}**\n`;
      
      // Calculate standard deviation
      const variance = calificaciones.reduce((sum, g) => sum + Math.pow(g.valor - averageGrade, 2), 0) / totalGrades;
      const stdDev = Math.sqrt(variance);
      analysis += `‚Ä¢ Desviaci√≥n est√°ndar: **${stdDev.toFixed(2)}**\n`;
      
      analysis += `‚Ä¢ Rango: **${Math.min(...sortedGrades).toFixed(1)} - ${Math.max(...sortedGrades).toFixed(1)}**\n\n`;
    } else if (details.focus === 'high_performers') {
      const highPerformers = calificaciones.filter(g => g.valor >= 8);
      const topPerformers = calificaciones.filter(g => g.valor >= 9);
      
      analysis += `‚≠ê **An√°lisis de Estudiantes Destacados:**\n`;
      analysis += `‚Ä¢ Estudiantes con ‚â•8: **${highPerformers.length}** (${((highPerformers.length / totalGrades) * 100).toFixed(1)}%)\n`;
      analysis += `‚Ä¢ Estudiantes con ‚â•9: **${topPerformers.length}** (${((topPerformers.length / totalGrades) * 100).toFixed(1)}%)\n`;
      analysis += `‚Ä¢ Promedio de destacados: **${highPerformers.length > 0 ? (highPerformers.reduce((sum, g) => sum + g.valor, 0) / highPerformers.length).toFixed(2) : 'N/A'}**\n\n`;
    } else if (details.focus === 'low_performers') {
      const lowPerformers = calificaciones.filter(g => g.valor < 6);
      const criticalPerformers = calificaciones.filter(g => g.valor < 4);
      
      analysis += `‚ö†Ô∏è **An√°lisis de Estudiantes en Riesgo:**\n`;
      analysis += `‚Ä¢ Estudiantes con <6: **${lowPerformers.length}** (${((lowPerformers.length / totalGrades) * 100).toFixed(1)}%)\n`;
      analysis += `‚Ä¢ Estudiantes cr√≠ticos (<4): **${criticalPerformers.length}** (${((criticalPerformers.length / totalGrades) * 100).toFixed(1)}%)\n`;
      analysis += `‚Ä¢ Promedio de riesgo: **${lowPerformers.length > 0 ? (lowPerformers.reduce((sum, g) => sum + g.valor, 0) / lowPerformers.length).toFixed(2) : 'N/A'}**\n\n`;
    } else {
      // General analysis
    const highPerformers = calificaciones.filter(g => g.valor >= 8).length;
    const lowPerformers = calificaciones.filter(g => g.valor < 6).length;
      const mediumPerformers = totalGrades - highPerformers - lowPerformers;
      
      analysis += `üìà **An√°lisis General:**\n`;
      analysis += `‚Ä¢ Promedio general: **${averageGrade.toFixed(2)}**\n`;
      analysis += `‚Ä¢ Estudiantes destacados (‚â•8): **${highPerformers}** (${((highPerformers / totalGrades) * 100).toFixed(1)}%)\n`;
      analysis += `‚Ä¢ Rendimiento medio (6-7.9): **${mediumPerformers}** (${((mediumPerformers / totalGrades) * 100).toFixed(1)}%)\n`;
      analysis += `‚Ä¢ Estudiantes en riesgo (<6): **${lowPerformers}** (${((lowPerformers / totalGrades) * 100).toFixed(1)}%)\n`;
      analysis += `‚Ä¢ Tasa de aprobaci√≥n: **${((totalGrades - lowPerformers) / totalGrades * 100).toFixed(1)}%**\n\n`;
    }

    // Add period-specific analysis if requested
    if (details.period !== 'all') {
      analysis += `üìÖ **An√°lisis por Per√≠odo (${details.period}):**\n`;
      analysis += `‚Ä¢ Datos espec√≠ficos del per√≠odo solicitado\n`;
      analysis += `‚Ä¢ Comparaci√≥n con per√≠odos anteriores\n\n`;
    }

    // Add comparison analysis if requested
    if (details.comparison) {
      analysis += `üîÑ **An√°lisis Comparativo:**\n`;
      analysis += `‚Ä¢ Comparaci√≥n entre diferentes grupos\n`;
      analysis += `‚Ä¢ Identificaci√≥n de tendencias\n`;
      analysis += `‚Ä¢ An√°lisis de variaciones\n\n`;
    }

    analysis += `üí° **Recomendaciones Inteligentes:**\n`;
    if (details.focus === 'low_performers') {
      analysis += `‚Ä¢ Implementar tutor√≠as personalizadas\n`;
      analysis += `‚Ä¢ Establecer metas espec√≠ficas por estudiante\n`;
      analysis += `‚Ä¢ Crear grupos de apoyo acad√©mico\n`;
      analysis += `‚Ä¢ Monitoreo semanal de progreso\n`;
    } else if (details.focus === 'high_performers') {
      analysis += `‚Ä¢ Crear programas de enriquecimiento\n`;
      analysis += `‚Ä¢ Asignar proyectos especiales\n`;
      analysis += `‚Ä¢ Reconocimiento y motivaci√≥n\n`;
      analysis += `‚Ä¢ Mentor√≠a para otros estudiantes\n`;
    } else {
      analysis += `‚Ä¢ Implementar tutor√≠as para estudiantes con bajo rendimiento\n`;
      analysis += `‚Ä¢ Reconocer y motivar a estudiantes destacados\n`;
      analysis += `‚Ä¢ Establecer metas personalizadas por estudiante\n`;
      analysis += `‚Ä¢ Crear programas de apoyo acad√©mico\n`;
      analysis += `‚Ä¢ An√°lisis continuo de tendencias\n`;
    }

    return analysis;
  };

  const generateAdvancedAttendanceAnalysis = (details: any): string => {
    if (!attendances) {
      return '‚ùå No tengo datos de asistencia disponibles para el an√°lisis.';
    }

    const totalRecords = attendances.length;
    const presentRecords = attendances.filter(a => a.present).length;
    const absentRecords = totalRecords - presentRecords;
    const attendanceRate = (presentRecords / totalRecords) * 100;

    let analysis = `üìÖ **An√°lisis Avanzado de Asistencia**\n\n`;

    if (details.focus === 'late') {
      const lateRecords = attendances.filter(a => a.tardanza).length;
      analysis += `‚è∞ **An√°lisis de Tardanzas:**\n`;
      analysis += `‚Ä¢ Tardanzas registradas: **${lateRecords}**\n`;
      analysis += `‚Ä¢ Porcentaje de tardanzas: **${((lateRecords / totalRecords) * 100).toFixed(1)}%**\n`;
      analysis += `‚Ä¢ Impacto en rendimiento acad√©mico\n\n`;
    } else if (details.focus === 'absent') {
      analysis += `‚ùå **An√°lisis de Ausencias:**\n`;
      analysis += `‚Ä¢ Ausencias totales: **${absentRecords}**\n`;
      analysis += `‚Ä¢ Porcentaje de ausencias: **${((absentRecords / totalRecords) * 100).toFixed(1)}%**\n`;
      analysis += `‚Ä¢ Patrones de ausentismo\n\n`;
    } else {
      analysis += `üìä **An√°lisis General de Asistencia:**\n`;
      analysis += `‚Ä¢ Total de registros: **${totalRecords}**\n`;
      analysis += `‚Ä¢ Tasa de asistencia: **${attendanceRate.toFixed(1)}%**\n`;
      analysis += `‚Ä¢ Presencias: **${presentRecords}** (${((presentRecords / totalRecords) * 100).toFixed(1)}%)\n`;
      analysis += `‚Ä¢ Ausencias: **${absentRecords}** (${((absentRecords / totalRecords) * 100).toFixed(1)}%)\n\n`;
    }

    if (details.trend) {
      analysis += `üìà **An√°lisis de Tendencia:**\n`;
      analysis += `‚Ä¢ Evoluci√≥n de la asistencia en el tiempo\n`;
      analysis += `‚Ä¢ Identificaci√≥n de patrones estacionales\n`;
      analysis += `‚Ä¢ Predicci√≥n de tendencias futuras\n\n`;
    }

    analysis += `üí° **Recomendaciones Inteligentes:**\n`;
    if (details.focus === 'late') {
      analysis += `‚Ä¢ Implementar sistema de puntualidad\n`;
      analysis += `‚Ä¢ Establecer consecuencias claras\n`;
      analysis += `‚Ä¢ Comunicaci√≥n con familias\n`;
    } else if (details.focus === 'absent') {
      analysis += `‚Ä¢ Investigar causas de ausentismo\n`;
      analysis += `‚Ä¢ Implementar estrategias de retenci√≥n\n`;
      analysis += `‚Ä¢ Seguimiento individualizado\n`;
    } else {
      analysis += `‚Ä¢ Identificar causas de ausentismo por materia\n`;
      analysis += `‚Ä¢ Implementar estrategias de motivaci√≥n\n`;
      analysis += `‚Ä¢ Establecer comunicaci√≥n con familias\n`;
      analysis += `‚Ä¢ Crear programas de retenci√≥n estudiantil\n`;
    }

    return analysis;
  };

  const generateAdvancedRiskAnalysis = (details: any): string => {
    if (!students || !calificaciones || !attendances) {
      return '‚ùå No tengo suficientes datos para identificar estudiantes en riesgo.';
    }

    let analysis = `‚ö†Ô∏è **An√°lisis Avanzado de Estudiantes en Riesgo**\n\n`;

    // Calculate risk levels based on details
    const riskLevel = details.level || 'general';
    const riskType = details.type || 'combined';

    const riskStudents = students.filter(student => {
      const studentGrades = calificaciones.filter(g => g.studentId === student.firestoreId);
      const studentAttendance = attendances.filter(a => a.studentId === student.firestoreId);
      
      const averageGrade = studentGrades.length > 0 
        ? studentGrades.reduce((sum, g) => sum + g.valor, 0) / studentGrades.length 
        : 10;
      
      const attendanceRate = studentAttendance.length > 0
        ? (studentAttendance.filter(a => a.present).length / studentAttendance.length) * 100
        : 100;

      // Different risk criteria based on type
      if (riskType === 'academic') {
        return averageGrade < 6;
      } else if (riskType === 'attendance') {
        return attendanceRate < 80;
      } else {
      return averageGrade < 6 || attendanceRate < 80;
      }
    });

    const criticalStudents = students.filter(student => {
      const studentGrades = calificaciones.filter(g => g.studentId === student.firestoreId);
      const studentAttendance = attendances.filter(a => a.studentId === student.firestoreId);
      
      const averageGrade = studentGrades.length > 0 
        ? studentGrades.reduce((sum, g) => sum + g.valor, 0) / studentGrades.length 
        : 10;
      
      const attendanceRate = studentAttendance.length > 0
        ? (studentAttendance.filter(a => a.present).length / studentAttendance.length) * 100
        : 100;

      return averageGrade < 4 || attendanceRate < 60;
    });

    if (riskLevel === 'critical') {
      analysis += `üî¥ **Estudiantes en Riesgo Cr√≠tico:**\n`;
      analysis += `‚Ä¢ Total de estudiantes cr√≠ticos: **${criticalStudents.length}**\n`;
      analysis += `‚Ä¢ Porcentaje de la poblaci√≥n: **${((criticalStudents.length / students.length) * 100).toFixed(1)}%**\n`;
      analysis += `‚Ä¢ Requieren intervenci√≥n inmediata\n\n`;
    } else if (riskLevel === 'high') {
      analysis += `üü° **Estudiantes en Alto Riesgo:**\n`;
      analysis += `‚Ä¢ Total de estudiantes en riesgo: **${riskStudents.length}**\n`;
      analysis += `‚Ä¢ Estudiantes cr√≠ticos: **${criticalStudents.length}**\n`;
      analysis += `‚Ä¢ Porcentaje de la poblaci√≥n: **${((riskStudents.length / students.length) * 100).toFixed(1)}%**\n\n`;
    } else {
      analysis += `‚ö†Ô∏è **An√°lisis General de Riesgo:**\n`;
      analysis += `‚Ä¢ Total de estudiantes en riesgo: **${riskStudents.length}**\n`;
      analysis += `‚Ä¢ Estudiantes cr√≠ticos: **${criticalStudents.length}**\n`;
      analysis += `‚Ä¢ Porcentaje de la poblaci√≥n: **${((riskStudents.length / students.length) * 100).toFixed(1)}%**\n\n`;
    }

    // Add type-specific analysis
    if (riskType === 'academic') {
      analysis += `üìö **An√°lisis de Riesgo Acad√©mico:**\n`;
      analysis += `‚Ä¢ Criterio: Calificaci√≥n promedio < 6\n`;
      analysis += `‚Ä¢ Estudiantes afectados: **${riskStudents.length}**\n\n`;
    } else if (riskType === 'attendance') {
      analysis += `üìÖ **An√°lisis de Riesgo por Asistencia:**\n`;
      analysis += `‚Ä¢ Criterio: Tasa de asistencia < 80%\n`;
      analysis += `‚Ä¢ Estudiantes afectados: **${riskStudents.length}**\n\n`;
    } else {
      analysis += `üéØ **Criterios de Riesgo Combinados:**\n`;
      analysis += `‚Ä¢ Calificaci√≥n promedio < 6\n`;
      analysis += `‚Ä¢ Tasa de asistencia < 80%\n`;
      analysis += `‚Ä¢ Estudiantes afectados: **${riskStudents.length}**\n\n`;
    }

    analysis += `üí° **Recomendaciones Inteligentes:**\n`;
    if (riskLevel === 'critical') {
      analysis += `‚Ä¢ Intervenci√≥n inmediata requerida\n`;
      analysis += `‚Ä¢ Contacto urgente con familias\n`;
      analysis += `‚Ä¢ Plan de acci√≥n personalizado\n`;
      analysis += `‚Ä¢ Seguimiento diario de progreso\n`;
    } else {
      analysis += `‚Ä¢ Programar reuniones con estudiantes en riesgo\n`;
      analysis += `‚Ä¢ Implementar planes de apoyo acad√©mico\n`;
      analysis += `‚Ä¢ Establecer seguimiento semanal de progreso\n`;
      analysis += `‚Ä¢ Crear alertas autom√°ticas para seguimiento\n`;
    }

    return analysis;
  };

  const generateAdvancedSystemStats = (details: any): string => {
    let analysis = `üìà **Estad√≠sticas Avanzadas del Sistema**\n\n`;

    // Basic stats
    analysis += `üìä **Datos Generales:**\n`;
    analysis += `‚Ä¢ üë• Estudiantes: **${students?.length || 0}**\n`;
    analysis += `‚Ä¢ üéì Cursos: **${courses?.length || 0}**\n`;
    analysis += `‚Ä¢ üìö Materias: **${subjects?.length || 0}**\n`;
    analysis += `‚Ä¢ üë®‚Äçüè´ Docentes: **${teachers?.length || 0}**\n`;
    analysis += `‚Ä¢ üìÖ Registros de asistencia: **${attendances?.length || 0}**\n`;
    analysis += `‚Ä¢ üìù Calificaciones: **${calificaciones?.length || 0}**\n`;
    analysis += `‚Ä¢ üìã Boletines: **${boletines?.length || 0}**\n`;
    analysis += `‚Ä¢ ‚ö†Ô∏è Alertas: **${alerts?.length || 0}**\n\n`;

    // Advanced calculations
    if (students && calificaciones) {
      const averageGrade = calificaciones.reduce((sum, g) => sum + g.valor, 0) / calificaciones.length;
      analysis += `üìà **M√©tricas de Rendimiento:**\n`;
      analysis += `‚Ä¢ Promedio general: **${averageGrade.toFixed(2)}**\n`;
      analysis += `‚Ä¢ Estudiantes con calificaciones: **${new Set(calificaciones.map(g => g.studentId)).size}**\n`;
      analysis += `‚Ä¢ Promedio de calificaciones por estudiante: **${(calificaciones.length / students.length).toFixed(1)}**\n\n`;
    }

    if (attendances) {
      const attendanceRate = (attendances.filter(a => a.present).length / attendances.length) * 100;
      analysis += `üìÖ **M√©tricas de Asistencia:**\n`;
      analysis += `‚Ä¢ Tasa de asistencia general: **${attendanceRate.toFixed(1)}%**\n`;
      analysis += `‚Ä¢ Estudiantes con registros de asistencia: **${new Set(attendances.map(a => a.studentId)).size}**\n\n`;
    }

    // System health indicators
    analysis += `üîß **Estado del Sistema:**\n`;
    analysis += `‚Ä¢ ‚úÖ Base de datos: Funcionando\n`;
    analysis += `‚Ä¢ ‚úÖ An√°lisis inteligente: Activo\n`;
    analysis += `‚Ä¢ ‚úÖ Alertas autom√°ticas: Configuradas\n`;
    analysis += `‚Ä¢ ‚úÖ Reportes: Generaci√≥n autom√°tica\n\n`;

    // Recent activity
    const recentBoletines = boletines?.filter((b: any) => {
      const date = new Date(b.fechaGeneracion || b.createdAt);
      const now = new Date();
      const diffDays = (now.getTime() - date.getTime()) / (1000 * 3600 * 24);
      return diffDays <= 7;
    }).length || 0;

    analysis += `üìÖ **Actividad Reciente (7 d√≠as):**\n`;
    analysis += `‚Ä¢ Boletines generados: **${recentBoletines}**\n`;
    analysis += `‚Ä¢ Alertas activas: **${alerts?.filter((a: any) => a.activa).length || 0}**\n\n`;

    analysis += `üöÄ **Funcionalidades Activas:**\n`;
    analysis += `‚Ä¢ An√°lisis inteligente de datos\n`;
    analysis += `‚Ä¢ Generaci√≥n autom√°tica de reportes\n`;
    analysis += `‚Ä¢ Sistema de alertas en tiempo real\n`;
    analysis += `‚Ä¢ Dashboard interactivo\n`;
    analysis += `‚Ä¢ Predicciones y tendencias\n`;

    return analysis;
  };

  const generateAdvancedHelpResponse = (details: any): string => {
    let analysis = `ü§ñ **Comandos y Funcionalidades Avanzadas**\n\n`;

    // Category-specific help
    if (details.category === 'analysis') {
      analysis += `üìä **An√°lisis de Datos Avanzado:**\n`;
      analysis += `‚Ä¢ "Analizar rendimiento acad√©mico detallado"\n`;
      analysis += `‚Ä¢ "Ver estad√≠sticas de asistencia por per√≠odo"\n`;
      analysis += `‚Ä¢ "Identificar estudiantes en riesgo cr√≠tico"\n`;
      analysis += `‚Ä¢ "Mostrar estad√≠sticas del sistema completo"\n`;
      analysis += `‚Ä¢ "Comparar rendimiento entre cursos"\n`;
      analysis += `‚Ä¢ "An√°lisis de tendencias y predicciones"\n\n`;
    } else if (details.category === 'users') {
      analysis += `üë• **Gesti√≥n de Usuarios:**\n`;
      analysis += `‚Ä¢ "Crear usuario administrador"\n`;
      analysis += `‚Ä¢ "Gestionar roles y permisos"\n`;
      analysis += `‚Ä¢ "Estudiantes con mejor rendimiento"\n`;
      analysis += `‚Ä¢ "Profesores destacados"\n`;
      analysis += `‚Ä¢ "Cursos m√°s populares"\n`;
      analysis += `‚Ä¢ "Materias con mejor promedio"\n\n`;
    } else if (details.category === 'reports') {
      analysis += `üìã **Reportes y Documentos:**\n`;
      analysis += `‚Ä¢ "Generar boletines autom√°ticos"\n`;
      analysis += `‚Ä¢ "Ver alertas cr√≠ticas"\n`;
      analysis += `‚Ä¢ "Exportar reportes personalizados"\n`;
      analysis += `‚Ä¢ "An√°lisis comparativo completo"\n`;
      analysis += `‚Ä¢ "Predicciones de rendimiento"\n`;
      analysis += `‚Ä¢ "Recomendaciones inteligentes"\n\n`;
    } else {
      analysis += `üìä **An√°lisis de Datos:**\n`;
      analysis += `‚Ä¢ "Analizar rendimiento acad√©mico"\n`;
      analysis += `‚Ä¢ "Ver estad√≠sticas de asistencia"\n`;
      analysis += `‚Ä¢ "Identificar estudiantes en riesgo"\n`;
      analysis += `‚Ä¢ "Mostrar estad√≠sticas del sistema"\n\n`;

      analysis += `üë• **Gesti√≥n de Usuarios:**\n`;
      analysis += `‚Ä¢ "Crear usuario" / "Usuarios"\n`;
      analysis += `‚Ä¢ "Estudiantes" / "Informaci√≥n de estudiantes"\n`;
      analysis += `‚Ä¢ "Profesores" / "Docentes"\n`;
      analysis += `‚Ä¢ "Cursos" / "Informaci√≥n de cursos"\n`;
      analysis += `‚Ä¢ "Materias" / "Asignaturas"\n\n`;

      analysis += `üìã **Reportes y Documentos:**\n`;
      analysis += `‚Ä¢ "Boletines" / "Informaci√≥n de boletines"\n`;
      analysis += `‚Ä¢ "Alertas" / "Ver alertas"\n`;
      analysis += `‚Ä¢ "Generar reporte"\n\n`;
    }

    analysis += `‚ùì **Consultas Espec√≠ficas:**\n`;
    analysis += `‚Ä¢ "¬øCu√°ntos estudiantes hay?"\n`;
    analysis += `‚Ä¢ "¬øCu√°l es el promedio general?"\n`;
    analysis += `‚Ä¢ "¬øHay alertas activas?"\n`;
    analysis += `‚Ä¢ "¬øCu√°ntos docentes est√°n activos?"\n`;
    analysis += `‚Ä¢ "¬øCu√°l es la tendencia de asistencia?"\n`;
    analysis += `‚Ä¢ "¬øQu√© materias tienen mejor rendimiento?"\n\n`;

    analysis += `‚ö° **Comandos Especiales:**\n`;
    analysis += `‚Ä¢ "Ayuda" - Mostrar esta lista\n`;
    analysis += `‚Ä¢ "Estad√≠sticas" - Ver datos del sistema\n`;
    analysis += `‚Ä¢ "An√°lisis completo" - Generar reporte detallado\n`;
    analysis += `‚Ä¢ "Comparar" - An√°lisis comparativo\n`;
    analysis += `‚Ä¢ "Predicci√≥n" - An√°lisis predictivo\n`;
    analysis += `‚Ä¢ "Recomendaci√≥n" - Sugerencias inteligentes\n\n`;

    analysis += `üí° **Sugerencias Avanzadas:**\n`;
    analysis += `‚Ä¢ Puedes hacer preguntas en lenguaje natural\n`;
    analysis += `‚Ä¢ El bot analiza el contexto de tu consulta\n`;
    analysis += `‚Ä¢ Respuestas personalizadas seg√∫n tus necesidades\n`;
    analysis += `‚Ä¢ Usa los botones de acci√≥n r√°pida para acceso directo\n`;
    analysis += `‚Ä¢ Solicita an√°lisis detallados o comparativos\n`;

    return analysis;
  };

  const generateAdvancedGreeting = (details: any): string => {
    const hour = details.time || new Date().getHours();
    const userName = details.user || user?.email?.split('@')[0];
    
    let greeting = '';
    if (hour < 12) greeting = 'üåÖ ¬°Buenos d√≠as!';
    else if (hour < 18) greeting = 'üåû ¬°Buenas tardes!';
    else greeting = 'üåô ¬°Buenas noches!';

    let analysis = `${greeting} ${userName}! ü§ñ\n\n`;

    analysis += `¬øEn qu√© puedo ayudarte hoy? Puedo:\n`;
    analysis += `‚Ä¢ üìä Analizar datos acad√©micos de manera inteligente\n`;
    analysis += `‚Ä¢ üìà Generar reportes personalizados\n`;
    analysis += `‚Ä¢ üîç Realizar an√°lisis comparativos\n`;
    analysis += `‚Ä¢ üìä Proporcionar insights educativos avanzados\n`;
    analysis += `‚Ä¢ ‚ö° Responder consultas espec√≠ficas del sistema\n`;
    analysis += `‚Ä¢ üéØ Crear recomendaciones personalizadas\n\n`;

    analysis += `**üí° Funcionalidades Avanzadas:**\n`;
    analysis += `‚Ä¢ An√°lisis de tendencias y predicciones\n`;
    analysis += `‚Ä¢ Comparaciones entre diferentes per√≠odos\n`;
    analysis += `‚Ä¢ Identificaci√≥n de patrones de rendimiento\n`;
    analysis += `‚Ä¢ Generaci√≥n de alertas inteligentes\n`;
    analysis += `‚Ä¢ Optimizaci√≥n de procesos acad√©micos\n\n`;

    analysis += `Solo dime qu√© necesitas y te ayudo con an√°lisis inteligente. üöÄ`;

    return analysis;
  };

  const generateAdvancedUserInfo = (details: any): string => {
    const totalUsers = teachers?.length || 0;
    const activeUsers = teachers?.filter((t: any) => t.activo !== false).length || 0;
    const inactiveUsers = totalUsers - activeUsers;
    
    let analysis = `üë• **Informaci√≥n Avanzada de Usuarios**\n\n`;

    // Action-specific analysis
    if (details.action === 'create') {
      analysis += `‚ûï **Creaci√≥n de Usuarios:**\n`;
      analysis += `‚Ä¢ Proceso simplificado disponible\n`;
      analysis += `‚Ä¢ Roles predefinidos: Admin, Profesor, Estudiante\n`;
      analysis += `‚Ä¢ Validaci√≥n autom√°tica de datos\n`;
      analysis += `‚Ä¢ Notificaciones de confirmaci√≥n\n\n`;
    } else {
      analysis += `üìä **Estad√≠sticas de Usuarios:**\n`;
      analysis += `‚Ä¢ Total de usuarios: **${totalUsers}**\n`;
      analysis += `‚Ä¢ Usuarios activos: **${activeUsers}** (${((activeUsers / totalUsers) * 100).toFixed(1)}%)\n`;
      analysis += `‚Ä¢ Usuarios inactivos: **${inactiveUsers}** (${((inactiveUsers / totalUsers) * 100).toFixed(1)}%)\n\n`;
    }

    // Role-specific analysis
    if (details.role === 'admin') {
      analysis += `üëë **Usuarios Administradores:**\n`;
      analysis += `‚Ä¢ Acceso completo al sistema\n`;
      analysis += `‚Ä¢ Gesti√≥n de usuarios y permisos\n`;
      analysis += `‚Ä¢ Configuraci√≥n del sistema\n`;
      analysis += `‚Ä¢ Reportes administrativos\n\n`;
    } else if (details.role === 'teacher') {
      analysis += `üë®‚Äçüè´ **Usuarios Docentes:**\n`;
      analysis += `‚Ä¢ Gesti√≥n de calificaciones\n`;
      analysis += `‚Ä¢ Registro de asistencia\n`;
      analysis += `‚Ä¢ Generaci√≥n de boletines\n`;
      analysis += `‚Ä¢ Comunicaci√≥n con estudiantes\n\n`;
    }

    analysis += `üí° **Funcionalidades Disponibles:**\n`;
    analysis += `‚Ä¢ Crear nuevos usuarios\n`;
    analysis += `‚Ä¢ Gestionar roles y permisos\n`;
    analysis += `‚Ä¢ Activar/desactivar usuarios\n`;
    analysis += `‚Ä¢ Ver historial de actividad\n`;
    analysis += `‚Ä¢ Configuraci√≥n de perfiles\n\n`;

    if (details.action === 'create') {
      analysis += `üîß **Proceso de Creaci√≥n:**\n`;
      analysis += `1. Ve a la secci√≥n "Usuarios"\n`;
      analysis += `2. Haz clic en "Agregar Usuario"\n`;
      analysis += `3. Completa los datos requeridos\n`;
      analysis += `4. Asigna el rol correspondiente\n`;
      analysis += `5. Confirma la creaci√≥n\n\n`;
    }

    analysis += `¬øNecesitas ayuda con alg√∫n proceso espec√≠fico?`;

    return analysis;
  };

  const generateAdvancedStudentInfo = (details: any): string => {
    const totalStudents = students?.length || 0;
    const activeStudents = students?.filter((s: any) => s.activo !== false).length || 0;
    const inactiveStudents = totalStudents - activeStudents;
    
    let analysis = `üéì **Informaci√≥n Avanzada de Estudiantes**\n\n`;

    // Focus-specific analysis
    if (details.focus === 'top') {
      const topStudents = students?.filter((s: any) => {
        const studentGrades = calificaciones?.filter((g: any) => g.studentId === s.firestoreId) || [];
        const averageGrade = studentGrades.length > 0 
          ? studentGrades.reduce((sum: any, g: any) => sum + g.valor, 0) / studentGrades.length 
          : 0;
        return averageGrade >= 8;
      }) || [];
      
      analysis += `‚≠ê **Estudiantes Destacados:**\n`;
      analysis += `‚Ä¢ Total de destacados: **${topStudents.length}**\n`;
      analysis += `‚Ä¢ Porcentaje de la poblaci√≥n: **${((topStudents.length / totalStudents) * 100).toFixed(1)}%**\n`;
      analysis += `‚Ä¢ Criterio: Promedio ‚â• 8\n\n`;
    } else if (details.focus === 'bottom') {
      const bottomStudents = students?.filter((s: any) => {
        const studentGrades = calificaciones?.filter((g: any) => g.studentId === s.firestoreId) || [];
        const averageGrade = studentGrades.length > 0 
          ? studentGrades.reduce((sum: any, g: any) => sum + g.valor, 0) / studentGrades.length 
          : 10;
        return averageGrade < 6;
      }) || [];
      
      analysis += `‚ö†Ô∏è **Estudiantes en Riesgo:**\n`;
      analysis += `‚Ä¢ Total en riesgo: **${bottomStudents.length}**\n`;
      analysis += `‚Ä¢ Porcentaje de la poblaci√≥n: **${((bottomStudents.length / totalStudents) * 100).toFixed(1)}%**\n`;
      analysis += `‚Ä¢ Criterio: Promedio < 6\n\n`;
    } else {
      analysis += `üìä **Estad√≠sticas Generales:**\n`;
      analysis += `‚Ä¢ Total de estudiantes: **${totalStudents}**\n`;
      analysis += `‚Ä¢ Estudiantes activos: **${activeStudents}** (${((activeStudents / totalStudents) * 100).toFixed(1)}%)\n`;
      analysis += `‚Ä¢ Estudiantes inactivos: **${inactiveStudents}** (${((inactiveStudents / totalStudents) * 100).toFixed(1)}%)\n`;
      analysis += `‚Ä¢ Con calificaciones: **${new Set(calificaciones?.map((g: any) => g.studentId) || []).size}**\n`;
      analysis += `‚Ä¢ Con asistencia: **${new Set(attendances?.map((a: any) => a.studentId) || []).size}**\n\n`;
    }

    // Course-specific analysis
    if (details.course) {
      analysis += `üìö **An√°lisis por Curso (${details.course}):**\n`;
      analysis += `‚Ä¢ Estudiantes en este curso\n`;
      analysis += `‚Ä¢ Rendimiento espec√≠fico\n`;
      analysis += `‚Ä¢ Comparaci√≥n con otros cursos\n\n`;
    }

    // Grade-specific analysis
    if (details.grade) {
      analysis += `üìà **An√°lisis por Calificaci√≥n (${details.grade}):**\n`;
      analysis += `‚Ä¢ Estudiantes con esta calificaci√≥n\n`;
      analysis += `‚Ä¢ Distribuci√≥n de notas\n`;
      analysis += `‚Ä¢ Tendencia de rendimiento\n\n`;
    }

    // Performance metrics
    if (calificaciones?.length > 0) {
      const averageGrade = calificaciones.reduce((sum: any, g: any) => sum + g.valor, 0) / calificaciones.length;
      analysis += `üìà **M√©tricas de Rendimiento:**\n`;
      analysis += `‚Ä¢ Promedio general: **${averageGrade.toFixed(2)}**\n`;
      analysis += `‚Ä¢ Calificaciones registradas: **${calificaciones.length}**\n`;
      analysis += `‚Ä¢ Estudiantes evaluados: **${new Set(calificaciones.map((g: any) => g.studentId)).size}**\n\n`;
    }

    if (attendances?.length > 0) {
      const attendanceRate = (attendances.filter((a: any) => a.present).length / attendances.length) * 100;
      analysis += `üìÖ **M√©tricas de Asistencia:**\n`;
      analysis += `‚Ä¢ Tasa de asistencia: **${attendanceRate.toFixed(1)}%**\n`;
      analysis += `‚Ä¢ Registros de asistencia: **${attendances.length}**\n`;
      analysis += `‚Ä¢ Estudiantes con asistencia: **${new Set(attendances.map((a: any) => a.studentId)).size}**\n\n`;
    }

    analysis += `üí° **Funcionalidades Disponibles:**\n`;
    analysis += `‚Ä¢ Registrar nuevos estudiantes\n`;
    analysis += `‚Ä¢ Ver historial acad√©mico\n`;
    analysis += `‚Ä¢ Gestionar matr√≠culas\n`;
    analysis += `‚Ä¢ Generar reportes individuales\n`;
    analysis += `‚Ä¢ An√°lisis de tendencias\n\n`;

    analysis += `¬øQuieres ver informaci√≥n espec√≠fica de alg√∫n estudiante?`;

    return analysis;
  };

  const generateAdvancedTeacherInfo = (details: any): string => {
    const totalTeachers = teachers?.length || 0;
    const activeTeachers = teachers?.filter((t: any) => t.activo !== false).length || 0;
    const inactiveTeachers = totalTeachers - activeTeachers;
    
    let analysis = `üë®‚Äçüè´ **Informaci√≥n Avanzada de Docentes**\n\n`;

    // Focus-specific analysis
    if (details.focus === 'top') {
      analysis += `‚≠ê **Docentes Destacados:**\n`;
      analysis += `‚Ä¢ Criterios de evaluaci√≥n: Rendimiento de estudiantes\n`;
      analysis += `‚Ä¢ Materias con mejor promedio\n`;
      analysis += `‚Ä¢ Reconocimientos y logros\n\n`;
    } else {
      analysis += `üìä **Estad√≠sticas Generales:**\n`;
      analysis += `‚Ä¢ Total de docentes: **${totalTeachers}**\n`;
      analysis += `‚Ä¢ Docentes activos: **${activeTeachers}** (${((activeTeachers / totalTeachers) * 100).toFixed(1)}%)\n`;
      analysis += `‚Ä¢ Docentes inactivos: **${inactiveTeachers}** (${((inactiveTeachers / totalTeachers) * 100).toFixed(1)}%)\n`;
      analysis += `‚Ä¢ Materias asignadas: **${subjects?.length || 0}**\n\n`;
    }

    // Subject-specific analysis
    if (details.subject) {
      analysis += `üìö **An√°lisis por Materia (${details.subject}):**\n`;
      analysis += `‚Ä¢ Docentes asignados a esta materia\n`;
      analysis += `‚Ä¢ Rendimiento de estudiantes\n`;
      analysis += `‚Ä¢ Comparaci√≥n entre docentes\n\n`;
    }

    // Distribution analysis
    analysis += `üìà **Distribuci√≥n de Carga:**\n`;
    analysis += `‚Ä¢ Materias con docente asignado: **${subjects?.length || 0}**\n`;
    analysis += `‚Ä¢ Cursos atendidos: **${courses?.length || 0}**\n`;
    analysis += `‚Ä¢ Promedio de materias por docente: **${subjects?.length && teachers?.length ? (subjects.length / teachers.length).toFixed(1) : 'N/A'}**\n\n`;

    // Performance metrics
    if (calificaciones?.length > 0 && subjects?.length > 0) {
      analysis += `üìä **M√©tricas de Rendimiento:**\n`;
      analysis += `‚Ä¢ Calificaciones registradas: **${calificaciones.length}**\n`;
      analysis += `‚Ä¢ Materias con calificaciones: **${new Set(calificaciones.map((g: any) => g.subjectId)).size}**\n`;
      analysis += `‚Ä¢ Promedio general de estudiantes: **${(calificaciones.reduce((sum: any, g: any) => sum + g.valor, 0) / calificaciones.length).toFixed(2)}**\n\n`;
    }

    analysis += `üí° **Funcionalidades Disponibles:**\n`;
    analysis += `‚Ä¢ Registrar nuevos docentes\n`;
    analysis += `‚Ä¢ Asignar materias\n`;
    analysis += `‚Ä¢ Gestionar horarios\n`;
    analysis += `‚Ä¢ Ver historial de clases\n`;
    analysis += `‚Ä¢ Evaluaci√≥n de rendimiento\n`;
    analysis += `‚Ä¢ Gesti√≥n de carga acad√©mica\n\n`;

    analysis += `¬øNecesitas informaci√≥n espec√≠fica de alg√∫n docente?`;

    return analysis;
  };

  const generateAdvancedCourseInfo = (details: any): string => {
    const totalCourses = courses?.length || 0;
    const activeCourses = courses?.filter((c: any) => c.activo !== false).length || 0;
    const inactiveCourses = totalCourses - activeCourses;
    
    let analysis = `üéì **Informaci√≥n Avanzada de Cursos**\n\n`;

    // Course-specific analysis
    if (details.course) {
      analysis += `üìö **An√°lisis del Curso (${details.course}):**\n`;
      analysis += `‚Ä¢ Estudiantes matriculados\n`;
      analysis += `‚Ä¢ Materias asignadas\n`;
      analysis += `‚Ä¢ Rendimiento espec√≠fico\n`;
      analysis += `‚Ä¢ Comparaci√≥n con otros cursos\n\n`;
    } else {
      analysis += `üìä **Estad√≠sticas Generales:**\n`;
      analysis += `‚Ä¢ Total de cursos: **${totalCourses}**\n`;
      analysis += `‚Ä¢ Cursos activos: **${activeCourses}** (${((activeCourses / totalCourses) * 100).toFixed(1)}%)\n`;
      analysis += `‚Ä¢ Cursos inactivos: **${inactiveCourses}** (${((inactiveCourses / totalCourses) * 100).toFixed(1)}%)\n`;
      analysis += `‚Ä¢ Estudiantes matriculados: **${students?.length || 0}**\n`;
      analysis += `‚Ä¢ Materias disponibles: **${subjects?.length || 0}**\n\n`;
    }

    // Comparison analysis
    if (details.comparison) {
      analysis += `üîÑ **An√°lisis Comparativo:**\n`;
      analysis += `‚Ä¢ Comparaci√≥n entre cursos\n`;
      analysis += `‚Ä¢ Rendimiento relativo\n`;
      analysis += `‚Ä¢ Distribuci√≥n de estudiantes\n`;
      analysis += `‚Ä¢ Eficiencia acad√©mica\n\n`;
    }

    // Performance metrics
    if (courses?.length > 0 && students?.length > 0) {
      analysis += `üìà **M√©tricas de Distribuci√≥n:**\n`;
      analysis += `‚Ä¢ Promedio de estudiantes por curso: **${(students.length / courses.length).toFixed(1)}**\n`;
      analysis += `‚Ä¢ Materias promedio por curso: **${subjects?.length && courses?.length ? (subjects.length / courses.length).toFixed(1) : 'N/A'}**\n`;
      analysis += `‚Ä¢ Densidad estudiantil: **${(students.length / courses.length).toFixed(1)} estudiantes/curso**\n\n`;
    }

    // Course performance analysis
    if (calificaciones?.length > 0 && courses?.length > 0) {
      analysis += `üìä **Rendimiento por Curso:**\n`;
      analysis += `‚Ä¢ Calificaciones registradas: **${calificaciones.length}**\n`;
      analysis += `‚Ä¢ Promedio general: **${(calificaciones.reduce((sum: any, g: any) => sum + g.valor, 0) / calificaciones.length).toFixed(2)}**\n`;
      analysis += `‚Ä¢ Estudiantes evaluados: **${new Set(calificaciones.map((g: any) => g.studentId)).size}**\n\n`;
    }

    analysis += `üí° **Funcionalidades Disponibles:**\n`;
    analysis += `‚Ä¢ Crear nuevos cursos\n`;
    analysis += `‚Ä¢ Gestionar matr√≠culas\n`;
    analysis += `‚Ä¢ Asignar materias\n`;
    analysis += `‚Ä¢ Generar reportes por curso\n`;
    analysis += `‚Ä¢ An√°lisis de rendimiento\n`;
    analysis += `‚Ä¢ Gesti√≥n de horarios\n\n`;

    analysis += `¬øQuieres ver informaci√≥n espec√≠fica de alg√∫n curso?`;

    return analysis;
  };

  const generateAdvancedSubjectInfo = (details: any): string => {
    const totalSubjects = subjects?.length || 0;
    const activeSubjects = subjects?.filter((s: any) => s.activo !== false).length || 0;
    const inactiveSubjects = totalSubjects - activeSubjects;
    
    let analysis = `üìö **Informaci√≥n Avanzada de Materias**\n\n`;

    // Subject-specific analysis
    if (details.subject) {
      analysis += `üìñ **An√°lisis de la Materia (${details.subject}):**\n`;
      analysis += `‚Ä¢ Docentes asignados\n`;
      analysis += `‚Ä¢ Estudiantes matriculados\n`;
      analysis += `‚Ä¢ Rendimiento espec√≠fico\n`;
      analysis += `‚Ä¢ Comparaci√≥n con otras materias\n\n`;
    } else {
      analysis += `üìä **Estad√≠sticas Generales:**\n`;
      analysis += `‚Ä¢ Total de materias: **${totalSubjects}**\n`;
      analysis += `‚Ä¢ Materias activas: **${activeSubjects}** (${((activeSubjects / totalSubjects) * 100).toFixed(1)}%)\n`;
      analysis += `‚Ä¢ Materias inactivas: **${inactiveSubjects}** (${((inactiveSubjects / totalSubjects) * 100).toFixed(1)}%)\n`;
      analysis += `‚Ä¢ Docentes asignados: **${teachers?.length || 0}**\n`;
      analysis += `‚Ä¢ Calificaciones registradas: **${calificaciones?.length || 0}**\n\n`;
    }

    // Performance analysis
    if (details.performance && calificaciones?.length > 0) {
      analysis += `üìà **An√°lisis de Rendimiento:**\n`;
      analysis += `‚Ä¢ Promedio general: **${(calificaciones.reduce((sum: any, g: any) => sum + g.valor, 0) / calificaciones.length).toFixed(2)}**\n`;
      analysis += `‚Ä¢ Materias con calificaciones: **${new Set(calificaciones.map((g: any) => g.subjectId)).size}**\n`;
      analysis += `‚Ä¢ Estudiantes evaluados: **${new Set(calificaciones.map((g: any) => g.studentId)).size}**\n\n`;
    }

    // Distribution analysis
    if (courses?.length > 0) {
      analysis += `üìà **Distribuci√≥n por Curso:**\n`;
      analysis += `‚Ä¢ Materias promedio por curso: **${(subjects?.length / courses.length).toFixed(1)}**\n`;
      analysis += `‚Ä¢ Cobertura de materias: **${((subjects?.length / courses.length) * 100).toFixed(1)}%**\n\n`;
    }

    analysis += `üí° **Funcionalidades Disponibles:**\n`;
    analysis += `‚Ä¢ Crear nuevas materias\n`;
    analysis += `‚Ä¢ Asignar docentes\n`;
    analysis += `‚Ä¢ Gestionar horarios\n`;
    analysis += `‚Ä¢ Ver rendimiento por materia\n`;
    analysis += `‚Ä¢ An√°lisis de tendencias\n`;
    analysis += `‚Ä¢ Gesti√≥n de carga acad√©mica\n\n`;

    analysis += `¬øNecesitas informaci√≥n espec√≠fica de alguna materia?`;

    return analysis;
  };

  const generateAdvancedBoletinInfo = (details: any): string => {
    const totalBoletines = boletines?.length || 0;
    const recentBoletines = boletines?.filter((b: any) => {
      const date = new Date(b.fechaGeneracion || b.createdAt);
      const now = new Date();
      const diffDays = (now.getTime() - date.getTime()) / (1000 * 3600 * 24);
      return diffDays <= 30;
    }).length || 0;
    
    let analysis = `üìã **Informaci√≥n Avanzada de Boletines**\n\n`;

    // Action-specific analysis
    if (details.action === 'generate') {
      analysis += `üîÑ **Generaci√≥n de Boletines:**\n`;
      analysis += `‚Ä¢ Proceso automatizado disponible\n`;
      analysis += `‚Ä¢ Generaci√≥n por per√≠odo acad√©mico\n`;
      analysis += `‚Ä¢ Inclusi√≥n de observaciones IA\n`;
      analysis += `‚Ä¢ Exportaci√≥n en m√∫ltiples formatos\n\n`;
    } else {
      analysis += `üìä **Estad√≠sticas Generales:**\n`;
      analysis += `‚Ä¢ Total de boletines: **${totalBoletines}**\n`;
      analysis += `‚Ä¢ Boletines recientes (30 d√≠as): **${recentBoletines}**\n`;
      analysis += `‚Ä¢ Estudiantes con boletines: **${students?.length || 0}**\n`;
      analysis += `‚Ä¢ Cursos con boletines: **${courses?.length || 0}**\n\n`;
    }

    // Period-specific analysis
    if (details.period !== 'all') {
      analysis += `üìÖ **An√°lisis por Per√≠odo (${details.period}):**\n`;
      analysis += `‚Ä¢ Boletines del per√≠odo espec√≠fico\n`;
      analysis += `‚Ä¢ Comparaci√≥n con per√≠odos anteriores\n`;
      analysis += `‚Ä¢ Tendencias de rendimiento\n\n`;
    }

    // Performance metrics
    if (students?.length > 0) {
      analysis += `üìà **M√©tricas de Distribuci√≥n:**\n`;
      analysis += `‚Ä¢ Promedio de boletines por estudiante: **${(boletines?.length / students.length).toFixed(1)}**\n`;
      analysis += `‚Ä¢ Boletines con observaciones: **${boletines?.filter((b: any) => b.observacionAutomatica).length || 0}**\n`;
      analysis += `‚Ä¢ Cobertura estudiantil: **${((boletines?.length / students.length) * 100).toFixed(1)}%**\n\n`;
    }

    analysis += `üí° **Funcionalidades Disponibles:**\n`;
    analysis += `‚Ä¢ Generar boletines autom√°ticos\n`;
    analysis += `‚Ä¢ Ver historial de boletines\n`;
    analysis += `‚Ä¢ Exportar reportes\n`;
    analysis += `‚Ä¢ Gestionar observaciones\n`;
    analysis += `‚Ä¢ An√°lisis de tendencias\n`;
    analysis += `‚Ä¢ Configuraci√≥n de formatos\n\n`;

    if (details.action === 'generate') {
      analysis += `üîß **Proceso de Generaci√≥n:**\n`;
      analysis += `1. Seleccionar per√≠odo acad√©mico\n`;
      analysis += `2. Elegir estudiantes o cursos\n`;
      analysis += `3. Configurar observaciones IA\n`;
      analysis += `4. Generar y revisar\n`;
      analysis += `5. Exportar o compartir\n\n`;
    }

    analysis += `¬øQuieres generar un nuevo bolet√≠n o ver alguno espec√≠fico?`;

    return analysis;
  };

  const generateAdvancedAlertInfo = (details: any): string => {
    const totalAlerts = alerts?.length || 0;
    const activeAlerts = alerts?.filter((a: any) => a.activa !== false).length || 0;
    const criticalAlerts = alerts?.filter((a: any) => a.tipo === 'critica').length || 0;
    const resolvedAlerts = totalAlerts - activeAlerts;
    
    let analysis = `‚ö†Ô∏è **Informaci√≥n Avanzada de Alertas**\n\n`;

    // Type-specific analysis
    if (details.type === 'critical') {
      analysis += `üî¥ **Alertas Cr√≠ticas:**\n`;
      analysis += `‚Ä¢ Total de alertas cr√≠ticas: **${criticalAlerts}**\n`;
      analysis += `‚Ä¢ Porcentaje del total: **${((criticalAlerts / totalAlerts) * 100).toFixed(1)}%**\n`;
      analysis += `‚Ä¢ Requieren atenci√≥n inmediata\n`;
      analysis += `‚Ä¢ Prioridad m√°xima\n\n`;
    } else {
      analysis += `üìä **Estad√≠sticas Generales:**\n`;
      analysis += `‚Ä¢ Total de alertas: **${totalAlerts}**\n`;
      analysis += `‚Ä¢ Alertas activas: **${activeAlerts}** (${((activeAlerts / totalAlerts) * 100).toFixed(1)}%)\n`;
      analysis += `‚Ä¢ Alertas cr√≠ticas: **${criticalAlerts}**\n`;
      analysis += `‚Ä¢ Alertas resueltas: **${resolvedAlerts}** (${((resolvedAlerts / totalAlerts) * 100).toFixed(1)}%)\n\n`;
    }

    // Status-specific analysis
    if (details.status === 'active') {
      analysis += `‚ö†Ô∏è **Alertas Activas:**\n`;
      analysis += `‚Ä¢ Requieren seguimiento\n`;
      analysis += `‚Ä¢ Acciones pendientes\n`;
      analysis += `‚Ä¢ Priorizaci√≥n necesaria\n\n`;
    }

    // Distribution analysis
    if (students?.length > 0) {
      analysis += `üìà **Distribuci√≥n por Estudiante:**\n`;
      analysis += `‚Ä¢ Alertas promedio por estudiante: **${(alerts?.length / students.length).toFixed(1)}**\n`;
      analysis += `‚Ä¢ Tasa de resoluci√≥n: **${totalAlerts > 0 ? (((totalAlerts - activeAlerts) / totalAlerts) * 100).toFixed(1) : 'N/A'}%**\n`;
      analysis += `‚Ä¢ Eficiencia del sistema de alertas\n\n`;
    }

    analysis += `üí° **Tipos de Alertas Disponibles:**\n`;
    analysis += `‚Ä¢ Bajo rendimiento acad√©mico\n`;
    analysis += `‚Ä¢ Ausentismo frecuente\n`;
    analysis += `‚Ä¢ Faltas de asistencia\n`;
    analysis += `‚Ä¢ Alertas del sistema\n`;
    analysis += `‚Ä¢ Alertas personalizadas\n\n`;

    analysis += `üîß **Funcionalidades:**\n`;
    analysis += `‚Ä¢ Crear nuevas alertas\n`;
    analysis += `‚Ä¢ Gestionar alertas existentes\n`;
    analysis += `‚Ä¢ Configurar alertas autom√°ticas\n`;
    analysis += `‚Ä¢ Seguimiento de resoluci√≥n\n`;
    analysis += `‚Ä¢ Reportes de alertas\n\n`;

    analysis += `¬øQuieres ver alertas espec√≠ficas o crear una nueva?`;

    return analysis;
  };

  const generateIntelligentGeneralResponse = (input: string, context: any): string => {
    let analysis = `ü§ñ **An√°lisis Inteligente de tu Consulta**\n\n`;

    // Analyze input complexity
    const wordCount = input.split(' ').length;
    const hasNumbers = /\d/.test(input);
    const hasQuestions = /\?/.test(input);

    if (wordCount > 10) {
      analysis += `üìù **Consulta Detallada Detectada:**\n`;
      analysis += `‚Ä¢ An√°lisis profundo requerido\n`;
      analysis += `‚Ä¢ M√∫ltiples aspectos a considerar\n`;
      analysis += `‚Ä¢ Respuesta personalizada en desarrollo\n\n`;
    } else if (hasNumbers) {
      analysis += `üî¢ **Consulta Num√©rica Detectada:**\n`;
      analysis += `‚Ä¢ B√∫squeda de datos espec√≠ficos\n`;
      analysis += `‚Ä¢ An√°lisis cuantitativo en proceso\n`;
      analysis += `‚Ä¢ M√©tricas relevantes identificadas\n\n`;
    } else if (hasQuestions) {
      analysis += `‚ùì **Consulta Interrogativa Detectada:**\n`;
      analysis += `‚Ä¢ Respuesta directa en preparaci√≥n\n`;
      analysis += `‚Ä¢ Informaci√≥n espec√≠fica solicitada\n`;
      analysis += `‚Ä¢ An√°lisis contextual aplicado\n\n`;
    } else {
      analysis += `üí≠ **Consulta General Detectada:**\n`;
      analysis += `‚Ä¢ An√°lisis contextual en progreso\n`;
      analysis += `‚Ä¢ Informaci√≥n relevante identificada\n`;
      analysis += `‚Ä¢ Respuesta personalizada generada\n\n`;
    }

    // Context-based response
    if (context.urgency === 'high') {
      analysis += `‚ö° **Prioridad Alta Detectada:**\n`;
      analysis += `‚Ä¢ Respuesta inmediata generada\n`;
      analysis += `‚Ä¢ Informaci√≥n cr√≠tica priorizada\n`;
      analysis += `‚Ä¢ Acciones urgentes identificadas\n\n`;
    }

    if (context.complexity === 'advanced') {
      analysis += `üî¨ **An√°lisis Avanzado Aplicado:**\n`;
      analysis += `‚Ä¢ M√©todos estad√≠sticos avanzados\n`;
      analysis += `‚Ä¢ An√°lisis de correlaciones\n`;
      analysis += `‚Ä¢ Predicciones y tendencias\n`;
      analysis += `‚Ä¢ Insights profundos generados\n\n`;
    }

    analysis += `üí° **Recomendaciones Inteligentes:**\n`;
    analysis += `‚Ä¢ Solicita an√°lisis espec√≠ficos para obtener informaci√≥n detallada\n`;
    analysis += `‚Ä¢ Usa palabras clave como "detallado", "completo", "comparar"\n`;
    analysis += `‚Ä¢ Pregunta por tendencias, predicciones o recomendaciones\n`;
    analysis += `‚Ä¢ Solicita reportes personalizados seg√∫n tus necesidades\n\n`;

    analysis += `¬øTe gustar√≠a que profundice en alg√∫n aspecto espec√≠fico o que realice un an√°lisis m√°s detallado?`;

    return analysis;
  };

  const generateComparisonAnalysis = (details: any): string => {
    let analysis = `üîÑ **An√°lisis Comparativo Avanzado**\n\n`;

    // Entity-specific comparisons
    if (details.entities?.includes('courses')) {
      analysis += `üìö **Comparaci√≥n entre Cursos:**\n`;
      analysis += `‚Ä¢ Rendimiento acad√©mico por curso\n`;
      analysis += `‚Ä¢ Tasa de asistencia comparativa\n`;
      analysis += `‚Ä¢ Distribuci√≥n de calificaciones\n`;
      analysis += `‚Ä¢ Eficiencia acad√©mica relativa\n\n`;
    }

    if (details.entities?.includes('subjects')) {
      analysis += `üìñ **Comparaci√≥n entre Materias:**\n`;
      analysis += `‚Ä¢ Promedio de calificaciones por materia\n`;
      analysis += `‚Ä¢ Dificultad relativa de asignaturas\n`;
      analysis += `‚Ä¢ Rendimiento estudiantil por materia\n`;
      analysis += `‚Ä¢ Tendencias de rendimiento\n\n`;
    }

    if (details.entities?.includes('students')) {
      analysis += `üë• **Comparaci√≥n entre Estudiantes:**\n`;
      analysis += `‚Ä¢ Rendimiento individual vs grupal\n`;
      analysis += `‚Ä¢ Progreso acad√©mico comparativo\n`;
      analysis += `‚Ä¢ Patrones de asistencia\n`;
      analysis += `‚Ä¢ Evoluci√≥n de calificaciones\n\n`;
    }

    if (details.entities?.includes('teachers')) {
      analysis += `üë®‚Äçüè´ **Comparaci√≥n entre Docentes:**\n`;
      analysis += `‚Ä¢ Efectividad de ense√±anza\n`;
      analysis += `‚Ä¢ Rendimiento de estudiantes por docente\n`;
      analysis += `‚Ä¢ M√©tricas de satisfacci√≥n\n`;
      analysis += `‚Ä¢ Eficiencia acad√©mica\n\n`;
    }

    // Metric-specific analysis
    if (details.metric === 'average') {
      analysis += `üìä **An√°lisis de Promedios:**\n`;
      analysis += `‚Ä¢ Comparaci√≥n de promedios generales\n`;
      analysis += `‚Ä¢ Tendencias de rendimiento\n`;
      analysis += `‚Ä¢ Variaciones estad√≠sticas\n\n`;
    } else if (details.metric === 'attendance') {
      analysis += `üìÖ **An√°lisis de Asistencia:**\n`;
      analysis += `‚Ä¢ Tasas de asistencia comparativas\n`;
      analysis += `‚Ä¢ Patrones de ausentismo\n`;
      analysis += `‚Ä¢ Correlaci√≥n con rendimiento\n\n`;
    } else if (details.metric === 'performance') {
      analysis += `üìà **An√°lisis de Rendimiento:**\n`;
      analysis += `‚Ä¢ M√©tricas de rendimiento comparativas\n`;
      analysis += `‚Ä¢ Indicadores de progreso\n`;
      analysis += `‚Ä¢ Factores de √©xito\n\n`;
    }

    analysis += `üí° **Insights del An√°lisis Comparativo:**\n`;
    analysis += `‚Ä¢ Identificaci√≥n de mejores pr√°cticas\n`;
    analysis += `‚Ä¢ √Åreas de mejora identificadas\n`;
    analysis += `‚Ä¢ Patrones de √©xito reconocidos\n`;
    analysis += `‚Ä¢ Recomendaciones basadas en datos\n`;

    return analysis;
  };

  const generatePredictionAnalysis = (details: any): string => {
    let analysis = `üîÆ **An√°lisis Predictivo Avanzado**\n\n`;

    // Timeframe-specific predictions
    if (details.timeframe === 'week') {
      analysis += `üìÖ **Predicciones Semanales:**\n`;
      analysis += `‚Ä¢ Tendencias de asistencia\n`;
      analysis += `‚Ä¢ Proyecciones de rendimiento\n`;
      analysis += `‚Ä¢ Alertas anticipadas\n`;
      analysis += `‚Ä¢ Planificaci√≥n acad√©mica\n\n`;
    } else if (details.timeframe === 'month') {
      analysis += `üìÖ **Predicciones Mensuales:**\n`;
      analysis += `‚Ä¢ Evoluci√≥n de calificaciones\n`;
      analysis += `‚Ä¢ Patrones de comportamiento\n`;
      analysis += `‚Ä¢ Riesgos acad√©micos\n`;
      analysis += `‚Ä¢ Oportunidades de mejora\n\n`;
    } else if (details.timeframe === 'quarter') {
      analysis += `üìÖ **Predicciones Trimestrales:**\n`;
      analysis += `‚Ä¢ Rendimiento acad√©mico proyectado\n`;
      analysis += `‚Ä¢ Tendencias de largo plazo\n`;
      analysis += `‚Ä¢ Impacto de intervenciones\n`;
      analysis += `‚Ä¢ Planificaci√≥n estrat√©gica\n\n`;
    } else {
      analysis += `üìÖ **Predicciones Generales:**\n`;
      analysis += `‚Ä¢ An√°lisis de tendencias\n`;
      analysis += `‚Ä¢ Proyecciones de rendimiento\n`;
      analysis += `‚Ä¢ Identificaci√≥n de riesgos\n`;
      analysis += `‚Ä¢ Oportunidades de optimizaci√≥n\n\n`;
    }

    // Metric-specific predictions
    if (details.metric === 'average') {
      analysis += `üìä **Predicciones de Promedio:**\n`;
      analysis += `‚Ä¢ Evoluci√≥n de calificaciones\n`;
      analysis += `‚Ä¢ Factores influyentes\n`;
      analysis += `‚Ä¢ Metas de rendimiento\n\n`;
    } else if (details.metric === 'attendance') {
      analysis += `üìÖ **Predicciones de Asistencia:**\n`;
      analysis += `‚Ä¢ Patrones de asistencia futura\n`;
      analysis += `‚Ä¢ Factores de riesgo\n`;
      analysis += `‚Ä¢ Estrategias de retenci√≥n\n\n`;
    } else if (details.metric === 'performance') {
      analysis += `üìà **Predicciones de Rendimiento:**\n`;
      analysis += `‚Ä¢ Proyecciones de √©xito acad√©mico\n`;
      analysis += `‚Ä¢ Indicadores de progreso\n`;
      analysis += `‚Ä¢ Intervenciones recomendadas\n\n`;
    }

    analysis += `üí° **Insights Predictivos:**\n`;
    analysis += `‚Ä¢ Modelos de machine learning aplicados\n`;
    analysis += `‚Ä¢ An√°lisis de patrones hist√≥ricos\n`;
    analysis += `‚Ä¢ Factores de correlaci√≥n identificados\n`;
    analysis += `‚Ä¢ Recomendaciones proactivas\n`;

    return analysis;
  };

  const generateRecommendationAnalysis = (details: any): string => {
    let analysis = `üí° **An√°lisis de Recomendaciones Avanzado**\n\n`;

    // Area-specific recommendations
    if (details.area === 'academic') {
      analysis += `üìö **Recomendaciones Acad√©micas:**\n`;
      analysis += `‚Ä¢ Estrategias de mejora de rendimiento\n`;
      analysis += `‚Ä¢ M√©todos de estudio optimizados\n`;
      analysis += `‚Ä¢ Recursos educativos recomendados\n`;
      analysis += `‚Ä¢ Planes de tutor√≠a personalizados\n\n`;
    } else if (details.area === 'attendance') {
      analysis += `üìÖ **Recomendaciones de Asistencia:**\n`;
      analysis += `‚Ä¢ Estrategias de motivaci√≥n\n`;
      analysis += `‚Ä¢ Programas de retenci√≥n\n`;
      analysis += `‚Ä¢ Comunicaci√≥n con familias\n`;
      analysis += `‚Ä¢ Incentivos de asistencia\n\n`;
    } else if (details.area === 'system') {
      analysis += `üîß **Recomendaciones del Sistema:**\n`;
      analysis += `‚Ä¢ Optimizaci√≥n de procesos\n`;
      analysis += `‚Ä¢ Mejoras en la interfaz\n`;
      analysis += `‚Ä¢ Funcionalidades adicionales\n`;
      analysis += `‚Ä¢ Eficiencia operativa\n\n`;
    } else {
      analysis += `üéØ **Recomendaciones Generales:**\n`;
      analysis += `‚Ä¢ Mejoras en todos los √°mbitos\n`;
      analysis += `‚Ä¢ Estrategias integrales\n`;
      analysis += `‚Ä¢ Optimizaci√≥n general\n`;
      analysis += `‚Ä¢ Desarrollo continuo\n\n`;
    }

    // Priority-based recommendations
    if (details.priority === 'high') {
      analysis += `‚ö° **Recomendaciones de Alta Prioridad:**\n`;
      analysis += `‚Ä¢ Implementaci√≥n inmediata requerida\n`;
      analysis += `‚Ä¢ Impacto significativo esperado\n`;
      analysis += `‚Ä¢ Recursos prioritarios asignados\n`;
      analysis += `‚Ä¢ Seguimiento intensivo\n\n`;
    } else {
      analysis += `üìã **Recomendaciones de Prioridad Normal:**\n`;
      analysis += `‚Ä¢ Implementaci√≥n gradual recomendada\n`;
      analysis += `‚Ä¢ Monitoreo continuo\n`;
      analysis += `‚Ä¢ Evaluaci√≥n de resultados\n`;
      analysis += `‚Ä¢ Ajustes seg√∫n necesidades\n\n`;
    }

    analysis += `üí° **Insights de Recomendaciones:**\n`;
    analysis += `‚Ä¢ Basadas en an√°lisis de datos\n`;
    analysis += `‚Ä¢ Personalizadas seg√∫n contexto\n`;
    analysis += `‚Ä¢ Evaluadas por impacto esperado\n`;
    analysis += `‚Ä¢ Con seguimiento de resultados\n`;

    return analysis;
  };

  const handleSendMessage = async () => {
    if (!inputValue.trim() || !isOpen) return;

    const userInput = inputValue.trim();
    addUserMessage(userInput);
    setInputValue('');

    const response = await generateBotResponse(userInput);
    addBotMessage(response);
    setIsTyping(false);
  };

  const handleSuggestionClick = async (suggestion: string) => {
    if (!isOpen) return;
    
    addUserMessage(suggestion);
    setIsTyping(true);
    const response = await generateBotResponse(suggestion);
    addBotMessage(response);
    setIsTyping(false);
  };

  const handleKeyPress = (e: React.KeyboardEvent<HTMLInputElement>) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSendMessage();
    }
  };

  const toggleBot = () => {
    if (!isOpen) {
      // Limpiar mensajes al abrir por primera vez
      setMessages([]);
      setMessageCount(0);
      setShowQuickActions(false);
      setIsTyping(false);
    }
    setIsOpen(!isOpen);
  };

  const clearChat = () => {
    setMessages([]);
    setMessageCount(0);
    setShowQuickActions(false);
    setIsTyping(false);
  };

  const closeBot = () => {
    setIsOpen(false);
    setMessageCount(0);
    setShowQuickActions(false);
    setIsTyping(false);
  };

  return (
    <>
      {/* Floating Bot Button */}
      <div className="fixed bottom-4 right-4 z-50">
        {!isOpen && (
          <div className="relative">
          <Button
            onClick={toggleBot}
              className="h-12 w-12 rounded-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105"
          >
              <Bot className="h-5 w-5 text-white" />
          </Button>
            {messageCount > 0 && (
              <Badge className="absolute -top-1 -right-1 h-5 w-5 rounded-full bg-red-500 text-white text-xs flex items-center justify-center animate-pulse">
                {messageCount}
              </Badge>
            )}
          </div>
        )}
      </div>

      {/* Bot Chat Window */}
      {isOpen && (
        <div className={`fixed z-50 bg-white rounded-xl shadow-2xl border transition-all duration-300 ${
          isMinimized 
            ? 'bottom-4 right-4 w-80 h-12' 
            : 'bottom-4 right-4 w-80 h-96'
        }`}>
          {/* Header */}
          <div className="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-3 rounded-t-xl">
            <div className="flex items-center justify-between">
              <div className="flex items-center space-x-2">
                <div className="relative">
                  <Bot className="h-4 w-4" />
                  <div className="absolute -top-0.5 -right-0.5 w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                </div>
                <div>
                  <span className="font-semibold text-sm">Asistente IA</span>
                  <div className="text-xs opacity-80">Inteligencia Artificial</div>
                </div>
              </div>
              <div className="flex items-center space-x-1">
                <Button
                  variant="ghost"
                  size="sm"
                  onClick={() => setIsMinimized(!isMinimized)}
                  className="text-white hover:bg-white/20 p-1 h-6 w-6"
                >
                  {isMinimized ? <ChevronUp className="h-3 w-3" /> : <ChevronDown className="h-3 w-3" />}
                </Button>
                <Button
                  variant="ghost"
                  size="sm"
                  onClick={closeBot}
                  className="text-white hover:bg-white/20 p-1 h-6 w-6"
                >
                  <X className="h-3 w-3" />
                </Button>
              </div>
            </div>
          </div>

          {!isMinimized && (
            <>
              {/* Quick Actions */}
              {showQuickActions && (
                <div className="p-2 bg-gray-50 border-b">
                  <div className="grid grid-cols-2 gap-2">
                    {quickActions.map((action) => (
                      <Card key={action.id} className="cursor-pointer hover:shadow-md transition-shadow" onClick={action.action}>
                        <CardContent className="p-2">
                          <div className="flex items-center space-x-2">
                            <div className={`p-1 rounded ${action.color} text-white`}>
                              <action.icon className="h-3 w-3" />
                            </div>
                            <div className="min-w-0 flex-1">
                              <div className="font-medium text-xs truncate">{action.title}</div>
                              <div className="text-xs text-gray-500 truncate">{action.description}</div>
                            </div>
                          </div>
                        </CardContent>
                      </Card>
                    ))}
                  </div>
                </div>
              )}

          {/* Messages */}
              <div className="flex-1 p-2 h-64">
            <ScrollArea className="h-full">
                  <div className="space-y-2">
                {messages.map((message) => (
                  <div
                    key={message.id}
                    className={`flex ${message.type === 'user' ? 'justify-end' : 'justify-start'}`}
                  >
                    <div
                          className={`max-w-[85%] p-2 rounded-lg ${
                        message.type === 'user'
                              ? 'bg-gradient-to-r from-blue-600 to-purple-600 text-white'
                          : 'bg-gray-100 text-gray-900'
                      }`}
                    >
                          <p className="text-xs whitespace-pre-wrap leading-relaxed">{message.content}</p>
                      {message.suggestions && (
                            <div className="mt-2 space-y-1">
                          {message.suggestions.map((suggestion, index) => (
                            <Button
                              key={index}
                              variant="outline"
                              size="sm"
                              onClick={() => handleSuggestionClick(suggestion)}
                                  className="w-full text-xs justify-start hover:bg-blue-50 h-6"
                            >
                              {suggestion}
                            </Button>
                          ))}
                        </div>
                      )}
                    </div>
                  </div>
                ))}
                {isTyping && (
                  <div className="flex justify-start">
                        <div className="bg-gray-100 p-2 rounded-lg">
                      <div className="flex space-x-1">
                            <div className="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce"></div>
                            <div className="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '0.1s' }}></div>
                            <div className="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '0.2s' }}></div>
                      </div>
                    </div>
                  </div>
                )}
                <div ref={messagesEndRef} />
              </div>
            </ScrollArea>
          </div>

          {/* Input */}
              <div className="p-2 border-t bg-gray-50">
                <div className="flex items-center space-x-2">
                  <Button
                    variant="ghost"
                    size="sm"
                    onClick={() => setShowQuickActions(!showQuickActions)}
                    className="text-gray-500 hover:text-gray-700 p-1 h-7 w-7"
                  >
                    <Zap className="h-3 w-3" />
                  </Button>
                  <div className="flex-1 min-w-0">
                                 <Input
                     ref={inputRef}
                     value={inputValue}
                     onChange={(e) => setInputValue(e.target.value)}
                     onKeyPress={handleKeyPress}
                     placeholder="Escribe tu mensaje..."
                     className="w-full h-7 text-xs"
                     disabled={isTyping || !isOpen}
                   />
                  </div>
                             <Button
                 onClick={handleSendMessage}
                 disabled={!inputValue.trim() || isTyping || !isOpen}
                 size="sm"
                 className="bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 p-1 h-7 w-7"
               >
                 <Send className="h-3 w-3" />
               </Button>
                  <Button
                    variant="ghost"
                    size="sm"
                    onClick={clearChat}
                    className="text-gray-500 hover:text-red-500 p-1 h-7 w-7"
                    title="Limpiar chat"
                  >
                    <Trash2 className="h-3 w-3" />
              </Button>
            </div>
          </div>
            </>
          )}
        </div>
      )}
    </>
  );
};

export default FloatingBot; 